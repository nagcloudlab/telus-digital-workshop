name: Deploy to AWS Staging

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ENVIRONMENT: staging

jobs:

  # Job 0: Complete Cleanup
  cleanup:
    name: üßπ Cleanup Existing Infrastructure
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: üèóÔ∏è Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false
    
    - name: üîß Terraform Init
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      run: |
        echo "Initializing Terraform..."
        terraform init || true
        echo "‚úÖ Terraform initialized"
    
    - name: üßπ Destroy Existing Infrastructure
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      env:
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        echo "Destroying existing infrastructure..."
        terraform destroy -auto-approve || echo "Nothing to destroy or destroy failed"
        echo "‚úÖ Terraform destroy complete"
    
    - name: üßπ Manual Cleanup of All Resources
      run: |
        echo "========================================"
        echo "Cleaning up all money-transfer resources"
        echo "========================================"
        
        # 1. Delete IAM Role and policies
        echo "1. Cleaning up IAM resources..."
        
        ROLE_NAME="money-transfer-ec2-role"
        POLICIES=$(aws iam list-attached-role-policies --role-name $ROLE_NAME --query 'AttachedPolicies[].PolicyArn' --output text 2>/dev/null || echo "")
        
        for policy in $POLICIES; do
          echo "   Detaching policy: $policy"
          aws iam detach-role-policy --role-name $ROLE_NAME --policy-arn $policy 2>/dev/null || true
        done
        
        PROFILE_NAME="money-transfer-ec2-profile"
        aws iam remove-role-from-instance-profile --instance-profile-name $PROFILE_NAME --role-name $ROLE_NAME 2>/dev/null || true
        aws iam delete-instance-profile --instance-profile-name $PROFILE_NAME 2>/dev/null || true
        echo "   Deleted instance profile"
        
        aws iam delete-role --role-name $ROLE_NAME 2>/dev/null && echo "   ‚úÖ Deleted IAM role" || echo "   ‚è≠Ô∏è  No IAM role to delete"
        
        # 2. Delete Key Pair
        echo "2. Deleting SSH key pair..."
        aws ec2 delete-key-pair --key-name money-transfer-key --region ${{ env.AWS_REGION }} 2>/dev/null && echo "   ‚úÖ Deleted key pair" || echo "   ‚è≠Ô∏è  No key pair"
        
        # 3. Terminate EC2 instances
        echo "3. Terminating EC2 instances..."
        INSTANCE_IDS=$(aws ec2 describe-instances --region ${{ env.AWS_REGION }} \
          --filters "Name=tag:Name,Values=money-transfer-app" "Name=instance-state-name,Values=running,stopped,pending,stopping" \
          --query 'Reservations[].Instances[].InstanceId' --output text 2>/dev/null || echo "")
        
        if [ ! -z "$INSTANCE_IDS" ]; then
          for instance_id in $INSTANCE_IDS; do
            echo "   Terminating instance: $instance_id"
            aws ec2 terminate-instances --instance-ids $instance_id --region ${{ env.AWS_REGION }} 2>/dev/null || true
          done
          echo "   Waiting 30 seconds for instances to terminate..."
          sleep 30
        else
          echo "   ‚è≠Ô∏è  No instances to terminate"
        fi
        
        # 4. Release Elastic IPs
        echo "4. Releasing Elastic IPs..."
        EIP_ALLOCS=$(aws ec2 describe-addresses --region ${{ env.AWS_REGION }} \
          --filters "Name=tag:Name,Values=money-transfer-eip" \
          --query 'Addresses[].AllocationId' --output text 2>/dev/null || echo "")
        
        for eip in $EIP_ALLOCS; do
          if [ ! -z "$eip" ]; then
            echo "   Releasing EIP: $eip"
            aws ec2 release-address --allocation-id $eip --region ${{ env.AWS_REGION }} 2>/dev/null || true
          fi
        done
        
        UNATTACHED_EIPS=$(aws ec2 describe-addresses --region ${{ env.AWS_REGION }} \
          --query 'Addresses[?AssociationId==null].AllocationId' --output text 2>/dev/null || echo "")
        
        for eip in $UNATTACHED_EIPS; do
          if [ ! -z "$eip" ]; then
            echo "   Releasing unattached EIP: $eip"
            aws ec2 release-address --allocation-id $eip --region ${{ env.AWS_REGION }} 2>/dev/null || true
          fi
        done
        echo "   ‚úÖ EIPs released"
        
        # 5. Delete Security Groups
        echo "5. Deleting security groups..."
        SG_IDS=$(aws ec2 describe-security-groups --region ${{ env.AWS_REGION }} \
          --filters "Name=group-name,Values=money-transfer-ec2-sg" \
          --query 'SecurityGroups[].GroupId' --output text 2>/dev/null || echo "")
        
        for sg_id in $SG_IDS; do
          if [ ! -z "$sg_id" ]; then
            echo "   Deleting security group: $sg_id"
            aws ec2 delete-security-group --group-id $sg_id --region ${{ env.AWS_REGION }} 2>/dev/null || true
          fi
        done
        echo "   ‚úÖ Security groups cleaned"
        
        # 6. Clean Terraform state
        echo "6. Cleaning Terraform state..."
        rm -rf money-transfer/infrastructure/terraform/aws/staging/.terraform/
        rm -f money-transfer/infrastructure/terraform/aws/staging/terraform.tfstate*
        rm -f money-transfer/infrastructure/terraform/aws/staging/tfplan
        echo "   ‚úÖ Terraform state cleaned"
        
        echo "========================================"
        echo "‚úÖ Cleanup Complete!"
        echo "========================================"

  # Job 1: Build JAR
  build:
    name: üî® Build Application
    runs-on: ubuntu-latest
    needs: cleanup
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Setup Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üî® Build with Maven
      run: |
        cd money-transfer
        mvn clean package -DskipTests
        echo "‚úÖ Build complete"
    
    - name: üì¶ Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: money-transfer-jar
        path: money-transfer/target/*.jar
        retention-days: 1

  # Job 2: Deploy Infrastructure with Terraform
  terraform-deploy:
    name: üèóÔ∏è Terraform Infrastructure
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
    
    outputs:
      ec2_public_ip: ${{ steps.terraform-outputs.outputs.ec2_public_ip }}
      ec2_instance_id: ${{ steps.terraform-outputs.outputs.ec2_instance_id }}
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: üèóÔ∏è Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false
    
    - name: üîß Terraform Init
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      run: |
        echo "Initializing Terraform..."
        rm -rf .terraform/
        rm -f terraform.tfstate*
        rm -f tfplan
        terraform init
        echo "‚úÖ Terraform initialized"
    
    - name: üìã Terraform Plan
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      env:
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        echo "Planning infrastructure changes..."
        terraform plan -out=tfplan -input=false
        echo "‚úÖ Terraform plan created"
    
    - name: üöÄ Terraform Apply
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      env:
        TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        echo "Applying infrastructure changes..."
        terraform apply -auto-approve -input=false tfplan
        echo "‚úÖ Infrastructure deployed"
    
    - name: üìä Get Terraform Outputs
      id: terraform-outputs
      working-directory: money-transfer/infrastructure/terraform/aws/staging
      run: |
        echo "Retrieving Terraform outputs..."
        
        EC2_IP=$(terraform output -raw ec2_public_ip)
        EC2_ID=$(terraform output -raw ec2_instance_id)
        APP_URL=$(terraform output -raw application_url)
        
        echo "ec2_public_ip=$EC2_IP" >> $GITHUB_OUTPUT
        echo "ec2_instance_id=$EC2_ID" >> $GITHUB_OUTPUT
        
        echo "=================================="
        echo "Infrastructure Outputs"
        echo "=================================="
        echo "EC2 Public IP: $EC2_IP"
        echo "EC2 Instance ID: $EC2_ID"
        echo "Application URL: $APP_URL"
        echo "=================================="

  # Job 3: Deploy Application to EC2
  deploy-app:
    name: üöÄ Deploy Application
    runs-on: ubuntu-latest
    needs: terraform-deploy
    environment:
      name: staging
      url: http://${{ needs.terraform-deploy.outputs.ec2_public_ip }}:8080
    
    steps:
    - name: üîê Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: üì• Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: money-transfer-jar
        path: ./artifacts
    
    - name: üîç Verify JAR Downloaded
      run: |
        echo "Checking for JAR file..."
        ls -lah ./artifacts/
        JAR_COUNT=$(ls -1 ./artifacts/*.jar 2>/dev/null | wc -l)
        if [ $JAR_COUNT -eq 0 ]; then
          echo "‚ùå ERROR: No JAR file found!"
          exit 1
        fi
        echo "‚úÖ Found $JAR_COUNT JAR file(s)"
    
    - name: üîë Setup SSH Key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > money-transfer-key.pem
        chmod 600 money-transfer-key.pem
        ls -lah money-transfer-key.pem
    
    - name: ‚è≥ Wait for EC2 to be ready
      env:
        EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
      run: |
        echo "Waiting for EC2 instance to be ready..."
        echo "EC2 IP: ${EC2_IP}"
        
        for i in {1..40}; do
          if ssh -i money-transfer-key.pem -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${EC2_IP} "echo 'ready'" 2>/dev/null; then
            echo "‚úÖ EC2 is ready!"
            exit 0
          fi
          echo "Attempt $i/40: Waiting for SSH..."
          sleep 15
        done
        echo "‚ùå EC2 not ready after 10 minutes"
        exit 1
    
    - name: üì§ Upload JAR to EC2
      env:
        EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
      run: |
        echo "Finding JAR file..."
        JAR_FILE=$(ls -1 ./artifacts/*.jar | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "‚ùå ERROR: No JAR file found in artifacts directory!"
          ls -lah ./artifacts/
          exit 1
        fi
        
        echo "Found JAR: $JAR_FILE"
        ls -lah "$JAR_FILE"
        
        echo "Uploading JAR to EC2..."
        scp -v -i money-transfer-key.pem -o StrictHostKeyChecking=no \
          "$JAR_FILE" ubuntu@${EC2_IP}:/tmp/money-transfer.jar
        
        echo "Verifying upload..."
        ssh -i money-transfer-key.pem -o StrictHostKeyChecking=no ubuntu@${EC2_IP} \
          "ls -lah /tmp/money-transfer.jar"
        
        echo "‚úÖ JAR uploaded successfully"
    
    - name: üöÄ Deploy and Start Application
      env:
        EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
      run: |
        echo "Deploying application on EC2..."
        
        ssh -i money-transfer-key.pem -o StrictHostKeyChecking=no ubuntu@${EC2_IP} << 'ENDSSH'
          set -e
          
          echo "Checking if JAR exists..."
          if [ ! -f /tmp/money-transfer.jar ]; then
            echo "‚ùå ERROR: JAR file not found at /tmp/money-transfer.jar"
            ls -lah /tmp/
            exit 1
          fi
          
          echo "JAR file found, proceeding with deployment..."

          sudo useradd -r -s /bin/false money-transfer 2>/dev/null || echo "User already exists"
          
          echo "Stopping existing service if running..."
          sudo systemctl stop money-transfer 2>/dev/null || echo "Service not running (first deployment)"
          
          echo "Creating application directory..."
          sudo mkdir -p /opt/money-transfer
          
          echo "Moving JAR to application directory..."
          sudo mv /tmp/money-transfer.jar /opt/money-transfer/money-transfer.jar
          
          echo "Setting permissions..."
          sudo chown -R money-transfer:money-transfer /opt/money-transfer
          sudo chmod 755 /opt/money-transfer/money-transfer.jar
          
          echo "Verifying JAR in final location..."
          ls -lah /opt/money-transfer/money-transfer.jar
          
          if [ ! -f /etc/systemd/system/money-transfer.service ]; then
            echo "Creating systemd service..."
            sudo bash -c 'cat > /etc/systemd/system/money-transfer.service << SERVICE
          [Unit]
          Description=Money Transfer Application
          After=network.target

          [Service]
          Type=simple
          User=money-transfer
          WorkingDirectory=/opt/money-transfer
          ExecStart=/usr/bin/java -Xmx512m -Xms256m -jar /opt/money-transfer/money-transfer.jar
          Restart=always
          RestartSec=10
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=money-transfer

          [Install]
          WantedBy=multi-user.target
          SERVICE'
            echo "‚úÖ Service file created"
          else
            echo "Service file already exists"
          fi
          
          echo "Reloading systemd..."
          sudo systemctl daemon-reload
          
          echo "Enabling service..."
          sudo systemctl enable money-transfer
          
          echo "Starting service..."
          sudo systemctl start money-transfer
          
          echo "Waiting for startup..."
          sleep 20
          
          echo "Checking service status..."
          sudo systemctl status money-transfer --no-pager || true
          
          echo "Checking application logs..."
          sudo journalctl -u money-transfer -n 50 --no-pager
          
          echo "‚úÖ Application deployed and started"
        ENDSSH
        
        echo "‚úÖ Deployment complete"

  # Job 4: Health Check
  health-check:
    name: üè• Health Check
    runs-on: ubuntu-latest
    needs: [terraform-deploy, deploy-app]
    
    steps:
    - name: ‚è≥ Wait for Application Warmup
      run: sleep 30
    
    - name: üè• Perform Health Check
      env:
        EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
      run: |
        echo "Checking application health..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${EC2_IP}:8080/actuator/health || echo "000")
          
          if [ "$HTTP_CODE" == "200" ]; then
            echo "‚úÖ Health check passed!"
            curl -s http:
