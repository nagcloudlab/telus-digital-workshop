name: Deploy to AWS Staging

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ENVIRONMENT: staging

jobs:

  cleanup:
    name: ğŸ§¹ Cleanup Existing Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: ğŸ”§ Terraform Init
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        run: terraform init || true

      - name: ğŸ§¹ Destroy Existing Infrastructure
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform destroy -auto-approve || true

      - name: ğŸ§¹ Manual Cleanup of All Resources
        run: |
          ROLE_NAME="money-transfer-ec2-role"
          PROFILE_NAME="money-transfer-ec2-profile"
          POLICIES=$(aws iam list-attached-role-policies --role-name $ROLE_NAME --query 'AttachedPolicies[].PolicyArn' --output text || echo "")
          for policy in $POLICIES; do aws iam detach-role-policy --role-name $ROLE_NAME --policy-arn $policy || true; done
          aws iam remove-role-from-instance-profile --instance-profile-name $PROFILE_NAME --role-name $ROLE_NAME || true
          aws iam delete-instance-profile --instance-profile-name $PROFILE_NAME || true
          aws iam delete-role --role-name $ROLE_NAME || true
          aws ec2 delete-key-pair --key-name money-transfer-key --region $AWS_REGION || true
          INSTANCE_IDS=$(aws ec2 describe-instances --region $AWS_REGION --filters "Name=tag:Name,Values=money-transfer-app" "Name=instance-state-name,Values=running,stopped,pending,stopping" --query 'Reservations[].Instances[].InstanceId' --output text || echo "")
          if [ -n "$INSTANCE_IDS" ]; then aws ec2 terminate-instances --instance-ids $INSTANCE_IDS --region $AWS_REGION || true; sleep 60; fi
          EIP_ALLOCS=$(aws ec2 describe-addresses --region $AWS_REGION --filters "Name=tag:Name,Values=money-transfer-eip" --query 'Addresses[].AllocationId' --output text || echo "")
          for eip in $EIP_ALLOCS; do aws ec2 release-address --allocation-id $eip --region $AWS_REGION || true; done
          UNATTACHED_EIPS=$(aws ec2 describe-addresses --region $AWS_REGION --query 'Addresses[?AssociationId==null].AllocationId' --output text || echo "")
          for eip in $UNATTACHED_EIPS; do aws ec2 release-address --allocation-id $eip --region $AWS_REGION || true; done
          SG_IDS=$(aws ec2 describe-security-groups --region $AWS_REGION --filters "Name=group-name,Values=money-transfer-ec2-sg*" --query 'SecurityGroups[].GroupId' --output text || echo "")
          for sg in $SG_IDS; do for attempt in {1..10}; do aws ec2 delete-security-group --group-id $sg --region $AWS_REGION && break || sleep 10; done; done
          rm -rf money-transfer/infrastructure/terraform/aws/staging/.terraform/
          rm -f money-transfer/infrastructure/terraform/aws/staging/terraform.tfstate*
          rm -f money-transfer/infrastructure/terraform/aws/staging/tfplan

  build:
    name: ğŸ”¨ Build Application
    runs-on: ubuntu-latest
    needs: cleanup

    steps:
      - uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: ğŸ”¨ Build with Maven
        run: |
          cd money-transfer
          mvn clean package -DskipTests

      - name: ğŸ“¦ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: money-transfer-jar
          path: money-transfer/target/*.jar
          retention-days: 1

  terraform-deploy:
    name: ğŸ—ï¸ Terraform Infrastructure
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging

    outputs:
      ec2_public_ip: ${{ steps.tfo.outputs.ec2_public_ip }}
      ec2_instance_id: ${{ steps.tfo.outputs.ec2_instance_id }}

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: ğŸ”§ Terraform Init
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        run: |
          rm -rf .terraform/
          rm -f terraform.tfstate*
          rm -f tfplan
          terraform init

      - name: ğŸ“‹ Terraform Plan
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform plan -out=tfplan -input=false

      - name: ğŸš€ Terraform Apply
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
        run: terraform apply -auto-approve tfplan

      - name: ğŸ“Š Get Terraform Outputs
        id: tfo
        working-directory: money-transfer/infrastructure/terraform/aws/staging
        run: |
          IP=$(terraform output -raw ec2_public_ip)
          ID=$(terraform output -raw ec2_instance_id)
          echo "ec2_public_ip=$IP" >> $GITHUB_OUTPUT
          echo "ec2_instance_id=$ID" >> $GITHUB_OUTPUT

  deploy-app:
    name: ğŸš€ Deploy Application
    runs-on: ubuntu-latest
    needs: terraform-deploy
    environment:
      name: staging
      url: http://${{ needs.terraform-deploy.outputs.ec2_public_ip }}:8080

    steps:
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¥ Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: money-transfer-jar
          path: ./artifacts

      - name: ğŸ” Verify JAR Downloaded
        run: |
          ls -lah ./artifacts/
          if [ "$(ls ./artifacts/*.jar 2>/dev/null | wc -l)" -eq 0 ]; then exit 1; fi

      - name: ğŸ”‘ Setup SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > money-transfer-key.pem
          chmod 600 money-transfer-key.pem

      - name: â³ Wait for EC2 to be ready
        env:
          EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
        run: |
          for i in {1..40}; do
            ssh -o StrictHostKeyChecking=no -i money-transfer-key.pem ubuntu@$EC2_IP "echo ready" && break
            sleep 15
          done

      - name: ğŸ“¤ Upload JAR to EC2
        env:
          EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
        run: |
          JAR_FILE=$(ls ./artifacts/*.jar | head -1)
          scp -o StrictHostKeyChecking=no -i money-transfer-key.pem "$JAR_FILE" ubuntu@$EC2_IP:/tmp/money-transfer.jar

      - name: ğŸš€ Deploy and Start Application
        env:
          EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
        run: |
          ssh -o StrictHostKeyChecking=no -i money-transfer-key.pem ubuntu@$EC2_IP 'bash -s' << 'ENDSSH'
            sudo systemctl stop money-transfer 2>/dev/null || true
            sudo mkdir -p /opt/money-transfer
            sudo mv /tmp/money-transfer.jar /opt/money-transfer/money-transfer.jar
            sudo chown ubuntu:ubuntu /opt/money-transfer/money-transfer.jar
            
            sudo tee /etc/systemd/system/money-transfer.service > /dev/null << 'SVCEOF'
[Unit]
Description=Money Transfer Application
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/money-transfer
ExecStart=/usr/bin/java -jar /opt/money-transfer/money-transfer.jar
Restart=always

[Install]
WantedBy=multi-user.target
SVCEOF

            sudo systemctl daemon-reload
            sudo systemctl restart money-transfer
            sudo systemctl enable money-transfer
            sleep 20
ENDSSH

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs:
      - terraform-deploy
      - deploy-app

    steps:
      - name: ğŸ¥ Perform Health Check
        env:
          EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
        run: |
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$EC2_IP:8080/actuator/health)
            [ "$STATUS" = "200" ] && exit 0
            sleep 10
          done
          exit 1

  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - terraform-deploy
      - deploy-app
      - health-check
    if: always()

    steps:
      - name: ğŸ“Š Summary
        env:
          EC2_IP: ${{ needs.terraform-deploy.outputs.ec2_public_ip }}
        run: |
          echo "====================================="
          echo "      ğŸš€ Deployment Successful"
          echo "====================================="
          echo "APP URL: http://$EC2_IP:8080"
          echo "HEALTH:  http://$EC2_IP:8080/actuator/health"
          echo "SSH:     ssh -i money-transfer-key.pem ubuntu@$EC2_IP"