name: Money Transfer Pipeline - CI/CD with Shift-Left Testing

on:
  push: # Trigger on pushes to specified branches
    branches: [ main, develop, feature/** ]
  pull_request: # Trigger on pull requests to specified branches
    branches: [ main, develop ]
  workflow_dispatch: # Manual trigger

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3072m'

jobs:
  # Job 1: Static Code Analysis (Shift-Left)
  static-analysis:
    name: üîç Static Code Analysis
    runs-on: ubuntu-latest
    if: true
    defaults:
      run:
        working-directory: ./money-transfer
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üèóÔ∏è Build Project
      run: mvn clean compile -DskipTests -B
    
    - name: üîç Run Checkstyle
      run: |
        echo "Running Checkstyle for code style violations..."
        mvn checkstyle:checkstyle -B || true
      continue-on-error: true
    
    - name: üìä Run PMD
      run: |
        echo "Running PMD for code quality issues..."
        mvn pmd:pmd -B || true
      continue-on-error: true
    
    - name: üìã Analysis Summary
      if: always()
      run: |
        echo "=================================="
        echo "Static Analysis Complete"
        echo "=================================="
        if [ -f "target/site/checkstyle.html" ]; then
          echo "‚úÖ Checkstyle report generated"
        fi
        if [ -f "target/site/pmd.html" ]; then
          echo "‚úÖ PMD report generated"
        fi
        echo "Download reports from Artifacts"
        echo "=================================="
    
    - name: üì§ Upload Checkstyle Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: checkstyle-report
        path: money-transfer/target/site/checkstyle.html
        if-no-files-found: warn
    
    - name: üì§ Upload PMD Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-report
        path: money-transfer/target/site/pmd.html
        if-no-files-found: warn    
  # Job 2: Security Scan (Gitleaks Only - Fast)
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    if: true
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    - name: üîê Check for Secrets with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    - name: üìã Security Summary
      if: always()
      run: |
        echo "=================================="
        echo "Security Scan Complete"
        echo "=================================="
        echo "‚úÖ Gitleaks secret scan completed"
        echo "Note: OWASP Dependency Check removed for speed"
        echo "Recommendation: Run OWASP separately weekly"
        echo "=================================="  
  # Job 3: Build and Unit Tests
  build-and-test:
    name: üèóÔ∏è Build & Unit Tests
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scan]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üèóÔ∏è Compile code
      run: |
        echo "Compiling application..."
        mvn clean compile -B -V
    
    - name: üß™ Run Unit Tests
      run: |
        echo "Running unit tests (tagged with @Tag('unit'))..."
        mvn test -B
    
    - name: üìä Generate Test Report
      if: always()
      run: mvn surefire-report:report-only
    
    - name: üìä Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Unit Test Results"
        echo "=================================="
        if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "‚úÖ Test reports generated"
          cat target/surefire-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "‚ö†Ô∏è  No test results found"
        fi
        echo "=================================="
    
    - name: üì§ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          money-transfer/target/surefire-reports/
          money-transfer/target/site/surefire-report.html
        if-no-files-found: warn
        retention-days: 30   
  # Job 4: Integration Tests
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    if: true
    needs: build-and-test
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üîó Run Integration Tests
      run: |
        echo "Running integration tests (tagged with @Tag('integration'))..."
        mvn verify -DskipUnitTests -B
    
    - name: üìä Generate Integration Test Report
      if: always()
      run: mvn failsafe-report:report-only || true
    
    - name: üìä Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Integration Test Results"
        echo "=================================="
        if ls target/failsafe-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "‚úÖ Test reports generated"
          cat target/failsafe-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "‚ö†Ô∏è  No test results found"
        fi
        echo "=================================="
    
    - name: üì§ Upload Integration Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          money-transfer/target/failsafe-reports/
          money-transfer/target/site/failsafe-report.html
        if-no-files-found: warn
        retention-days: 30    
  # Job 5: Code Coverage Analysis
  coverage-analysis:
    name: üìä Code Coverage Analysis
    runs-on: ubuntu-latest
    if: true
    needs: [integration-tests]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: üìä Run Tests with Coverage
      run: |
        echo "Running all tests with coverage tracking..."
        mvn clean test -B
    
    - name: üìà Check Coverage Threshold
      run: |
        echo "Checking code coverage thresholds..."
        
        if [ -f "target/site/jacoco/jacoco.csv" ]; then
          INSTRUCTION_COVERAGE=$(awk -F, '
            NR>1 {
              instructions_missed += $4;
              instructions_covered += $5;
            }
            END {
              if (instructions_missed + instructions_covered > 0) {
                print int((instructions_covered * 100) / (instructions_missed + instructions_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          BRANCH_COVERAGE=$(awk -F, '
            NR>1 {
              branches_missed += $6;
              branches_covered += $7;
            }
            END {
              if (branches_missed + branches_covered > 0) {
                print int((branches_covered * 100) / (branches_missed + branches_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          echo "üìä Coverage Results:"
          echo "   Instruction Coverage: ${INSTRUCTION_COVERAGE}%"
          echo "   Branch Coverage: ${BRANCH_COVERAGE}%"
          
          MIN_INSTRUCTION_COVERAGE=16
          MIN_BRANCH_COVERAGE=2
          
          if [ "$INSTRUCTION_COVERAGE" -lt "$MIN_INSTRUCTION_COVERAGE" ]; then
            echo "‚ùå Instruction coverage ${INSTRUCTION_COVERAGE}% is below threshold ${MIN_INSTRUCTION_COVERAGE}%"
            exit 1
          fi
          
          if [ "$BRANCH_COVERAGE" -lt "$MIN_BRANCH_COVERAGE" ]; then
            echo "‚ö†Ô∏è  Branch coverage ${BRANCH_COVERAGE}% is below threshold ${MIN_BRANCH_COVERAGE}%"
            echo "    This is a warning, not blocking the build"
          fi
          
          echo "‚úÖ Coverage thresholds met!"
          echo "INSTRUCTION_COVERAGE=${INSTRUCTION_COVERAGE}" >> $GITHUB_ENV
          echo "BRANCH_COVERAGE=${BRANCH_COVERAGE}" >> $GITHUB_ENV
        else
          echo "‚ö†Ô∏è  No coverage report found"
        fi
    
    - name: üì§ Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: money-transfer/target/site/jacoco/
        retention-days: 30
    
    - name: üí¨ Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = process.env.INSTRUCTION_COVERAGE || 'N/A';
          const branch = process.env.BRANCH_COVERAGE || 'N/A';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üìä Code Coverage Report\n\n` +
                  `- **Instruction Coverage:** ${coverage}%\n` +
                  `- **Branch Coverage:** ${branch}%\n\n` +
                  `‚úÖ Coverage thresholds met!\n\n` +
                  `[View detailed report in artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})`
          });
               