name: Money Transfer Pipeline - CI/CD with Shift-Left Testing

on:
  push: # Trigger on pushes to specified branches
    branches: [ main, develop, feature/** ]
  pull_request: # Trigger on pull requests to specified branches
    branches: [ main, develop ]
  workflow_dispatch: # Manual trigger

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx3072m'

jobs:
  # Job 1: Static Code Analysis (Shift-Left)
  static-analysis:
    name: ðŸ” Static Code Analysis
    runs-on: ubuntu-latest
    if: true
    defaults:
      run:
        working-directory: ./money-transfer
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ðŸ—ï¸ Build Project
      run: mvn clean compile -DskipTests -B
    
    - name: ðŸ” Run Checkstyle
      run: |
        echo "Running Checkstyle for code style violations..."
        mvn checkstyle:checkstyle -B || true
      continue-on-error: true
    
    - name: ðŸ“Š Run PMD
      run: |
        echo "Running PMD for code quality issues..."
        mvn pmd:pmd -B || true
      continue-on-error: true
    
    - name: ðŸ“‹ Analysis Summary
      if: always()
      run: |
        echo "=================================="
        echo "Static Analysis Complete"
        echo "=================================="
        if [ -f "target/site/checkstyle.html" ]; then
          echo "âœ… Checkstyle report generated"
        fi
        if [ -f "target/site/pmd.html" ]; then
          echo "âœ… PMD report generated"
        fi
        echo "Download reports from Artifacts"
        echo "=================================="
    
    - name: ðŸ“¤ Upload Checkstyle Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: checkstyle-report
        path: money-transfer/target/site/checkstyle.html
        if-no-files-found: warn
    
    - name: ðŸ“¤ Upload PMD Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pmd-report
        path: money-transfer/target/site/pmd.html
        if-no-files-found: warn    
  # Job 2: Security Scan (Gitleaks Only - Fast)
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: true
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    - name: ðŸ” Check for Secrets with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    - name: ðŸ“‹ Security Summary
      if: always()
      run: |
        echo "=================================="
        echo "Security Scan Complete"
        echo "=================================="
        echo "âœ… Gitleaks secret scan completed"
        echo "Note: OWASP Dependency Check removed for speed"
        echo "Recommendation: Run OWASP separately weekly"
        echo "=================================="  
  # Job 3: Build and Unit Tests
  build-and-test:
    name: ðŸ—ï¸ Build & Unit Tests
    runs-on: ubuntu-latest
    needs: [static-analysis, security-scan]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ðŸ” Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ðŸ—ï¸ Compile code
      run: |
        echo "Compiling application..."
        mvn clean compile -B -V
    
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "Running unit tests (tagged with @Tag('unit'))..."
        mvn test -B
    
    - name: ðŸ“Š Generate Test Report
      if: always()
      run: mvn surefire-report:report-only
    
    - name: ðŸ“Š Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Unit Test Results"
        echo "=================================="
        if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "âœ… Test reports generated"
          cat target/surefire-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "âš ï¸  No test results found"
        fi
        echo "=================================="
    
    - name: ðŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          money-transfer/target/surefire-reports/
          money-transfer/target/site/surefire-report.html
        if-no-files-found: warn
        retention-days: 30   
  # Job 4: Integration Tests
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    if: true
    needs: build-and-test
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ðŸ” Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ðŸ”— Run Integration Tests
      run: |
        echo "Running integration tests (tagged with @Tag('integration'))..."
        mvn verify -DskipUnitTests -B
    
    - name: ðŸ“Š Generate Integration Test Report
      if: always()
      run: mvn failsafe-report:report-only || true
    
    - name: ðŸ“Š Test Summary
      if: always()
      run: |
        echo "=================================="
        echo "Integration Test Results"
        echo "=================================="
        if ls target/failsafe-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "âœ… Test reports generated"
          cat target/failsafe-reports/*.txt 2>/dev/null || echo "Summary files not found"
        else
          echo "âš ï¸  No test results found"
        fi
        echo "=================================="
    
    - name: ðŸ“¤ Upload Integration Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          money-transfer/target/failsafe-reports/
          money-transfer/target/site/failsafe-report.html
        if-no-files-found: warn
        retention-days: 30    
  # Job 5: Code Coverage Analysis
  coverage-analysis:
    name: ðŸ“Š Code Coverage Analysis
    runs-on: ubuntu-latest
    if: true
    needs: [integration-tests]
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ðŸ” Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: ðŸ“Š Run Tests with Coverage
      run: |
        echo "Running all tests with coverage tracking..."
        mvn clean test -B
    
    - name: ðŸ“ˆ Check Coverage Threshold
      run: |
        echo "Checking code coverage thresholds..."
        
        if [ -f "target/site/jacoco/jacoco.csv" ]; then
          INSTRUCTION_COVERAGE=$(awk -F, '
            NR>1 {
              instructions_missed += $4;
              instructions_covered += $5;
            }
            END {
              if (instructions_missed + instructions_covered > 0) {
                print int((instructions_covered * 100) / (instructions_missed + instructions_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          BRANCH_COVERAGE=$(awk -F, '
            NR>1 {
              branches_missed += $6;
              branches_covered += $7;
            }
            END {
              if (branches_missed + branches_covered > 0) {
                print int((branches_covered * 100) / (branches_missed + branches_covered));
              } else {
                print 0;
              }
            }
          ' target/site/jacoco/jacoco.csv)
          
          echo "ðŸ“Š Coverage Results:"
          echo "   Instruction Coverage: ${INSTRUCTION_COVERAGE}%"
          echo "   Branch Coverage: ${BRANCH_COVERAGE}%"
          
          MIN_INSTRUCTION_COVERAGE=16
          MIN_BRANCH_COVERAGE=2
          
          if [ "$INSTRUCTION_COVERAGE" -lt "$MIN_INSTRUCTION_COVERAGE" ]; then
            echo "âŒ Instruction coverage ${INSTRUCTION_COVERAGE}% is below threshold ${MIN_INSTRUCTION_COVERAGE}%"
            exit 1
          fi
          
          if [ "$BRANCH_COVERAGE" -lt "$MIN_BRANCH_COVERAGE" ]; then
            echo "âš ï¸  Branch coverage ${BRANCH_COVERAGE}% is below threshold ${MIN_BRANCH_COVERAGE}%"
            echo "    This is a warning, not blocking the build"
          fi
          
          echo "âœ… Coverage thresholds met!"
          echo "INSTRUCTION_COVERAGE=${INSTRUCTION_COVERAGE}" >> $GITHUB_ENV
          echo "BRANCH_COVERAGE=${BRANCH_COVERAGE}" >> $GITHUB_ENV
        else
          echo "âš ï¸  No coverage report found"
        fi
    
    - name: ðŸ“¤ Upload Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: money-transfer/target/site/jacoco/
        retention-days: 30
    
    - name: ðŸ’¬ Comment Coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = process.env.INSTRUCTION_COVERAGE || 'N/A';
          const branch = process.env.BRANCH_COVERAGE || 'N/A';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ“Š Code Coverage Report\n\n` +
                  `- **Instruction Coverage:** ${coverage}%\n` +
                  `- **Branch Coverage:** ${branch}%\n\n` +
                  `âœ… Coverage thresholds met!\n\n` +
                  `[View detailed report in artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})`
          });
  
  # Job 6: Smoke & Performance Tests
  smoke-and-performance-tests:
    name: ðŸ”¥ Smoke & Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: ./money-transfer
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    - name: ðŸ“¦ Package Application
      run: mvn clean package -DskipTests -B
    
    - name: ðŸš€ Start Application
      run: |
        echo "ðŸ”¥ Starting application for smoke tests..."
        java -jar target/*.jar &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        echo "Waiting for application to be ready..."
        timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done' || {
          echo "âŒ Application failed to start"
          exit 1
        }
        
        echo "âœ… Application started successfully"
    
    - name: ðŸ”¥ Run Smoke Tests
      run: |
        echo "=================================="
        echo "Running Smoke Tests"
        echo "=================================="
        
        echo "ðŸ”¥ Smoke Test 1: Health endpoint..."
        curl -f http://localhost:8080/actuator/health || exit 1
        echo "âœ… Health endpoint OK"
        
        echo "ðŸ”¥ Smoke Test 2: API endpoints..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/accounts)
        if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ]; then
          echo "âœ… API responding (HTTP $HTTP_CODE)"
        else
          echo "âŒ API not responding (HTTP $HTTP_CODE)"
          exit 1
        fi
        
        echo "âœ… All smoke tests passed!"
    
    - name: âš¡ Run Performance Tests
      run: |
        echo "=================================="
        echo "Running Performance Tests"
        echo "=================================="
        
        HEALTH_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://localhost:8080/actuator/health)
        echo "âš¡ Health response: ${HEALTH_TIME}s"
        
        echo "âš¡ Load test: 100 concurrent requests..."
        START_TIME=$(date +%s)
        for i in {1..100}; do
          curl -s http://localhost:8080/actuator/health > /dev/null &
        done
        wait
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        
        if [ $DURATION -eq 0 ]; then
          THROUGHPUT=100
        else
          THROUGHPUT=$((100 / DURATION))
        fi
        
        echo "ðŸ“Š Performance Summary:"
        echo "   Response time: ${HEALTH_TIME}s"
        echo "   Load duration: ${DURATION}s"
        echo "   Throughput: ${THROUGHPUT} req/s"
        
        if (( $(echo "$HEALTH_TIME > 1.0" | bc -l) )); then
          echo "âš ï¸  Response time exceeds 1 second"
        else
          echo "âœ… Performance acceptable"
        fi
        
        echo "HEALTH_TIME=${HEALTH_TIME}" >> $GITHUB_ENV
        echo "THROUGHPUT=${THROUGHPUT}" >> $GITHUB_ENV
      continue-on-error: true
    
    - name: ðŸ›‘ Stop Application
      if: always()
      run: |
        if [ ! -z "$APP_PID" ]; then
          echo "Stopping application (PID: $APP_PID)..."
          kill $APP_PID 2>/dev/null || true
          sleep 2
        fi
    
    - name: ðŸ’¬ Comment Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const healthTime = process.env.HEALTH_TIME || 'N/A';
          const throughput = process.env.THROUGHPUT || 'N/A';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ”¥ Smoke & Performance Test Results\n\n` +
                  `### Smoke Tests\n` +
                  `âœ… Application starts successfully\n` +
                  `âœ… Health endpoint accessible\n` +
                  `âœ… API endpoints responding\n\n` +
                  `### Performance\n` +
                  `- **Response Time:** ${healthTime}s\n` +
                  `- **Throughput:** ${throughput} req/s\n\n` +
                  `${healthTime !== 'N/A' && parseFloat(healthTime) < 1.0 ? 'âœ…' : 'âš ï¸'} Performance within limits`
          });
      continue-on-error: true
             